<!DOCTYPE html>
<html lang="hy">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Վաճառքի Կետ (POS)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

    <style>
        /* Մոբայլ ոճեր (անփոփոխ) */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 10px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 450px; margin: 0 auto; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #007bff; margin-bottom: 20px; }
        #scanner-area { position: relative; width: 100%; height: 200px; background-color: #000; margin-bottom: 15px; border-radius: 4px; overflow: hidden; }
        #videoElement { width: 100%; height: 100%; object-fit: cover; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; background-color: rgba(0, 0, 0, 0.4); font-weight: bold; }
        input[type="text"], input[type="number"], button { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        button { cursor: pointer; color: #fff; border: none; font-weight: bold; }
        .btn-primary { background-color: #28a745; }
        .btn-secondary { background-color: #007bff; }
        .btn-danger { background-color: #dc3545; }
        #products-list { border-top: 2px solid #eee; padding-top: 10px; margin-top: 10px; }
        .product-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .item-details { flex-grow: 1; }
        .item-quantity-controls { display: flex; align-items: center; }
        .quantity-display { margin: 0 10px; font-weight: bold; color: #007bff; min-width: 20px; text-align: center; }
        #total-section div { display: flex; justify-content: space-between; padding: 5px 0; }
        #final-total { font-size: 1.5em; font-weight: bold; color: #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <h1>Վաճառքի Կետ</h1>

    <div id="scanner-area">
        <video id="videoElement" autoplay playsinline></video>
        <div class="overlay" id="overlay">Սպասում է տեսախցիկին...</div>
    </div>
    
    <input type="text" id="manualBarcodeInput" placeholder="Կոդի Ձեռքով Մուտքագրում">
    <button class="btn-secondary" onclick="handleManualInput()">Ավելացնել Կոդը (Ձեռքով)</button>

    <hr>
    
    <h2>Ընթացիկ Պատվեր</h2>
    <div id="products-list">
        <p id="empty-list-message">Ցուցակը դատարկ է։</p>
    </div>

    <hr>

    <div id="discount-section">
        <label for="discount-input">Զեղչ (%)</label>
        <input type="number" id="discount-input" min="0" max="100" value="0" oninput="calculateTotal()">
    </div>

    <div id="total-section">
        <div><span>Ենթագումար:</span> <span id="sub-total">0.00 Դր</span></div>
        <div><span>Զեղչի Գումար:</span> <span id="discount-amount">0.00 Դր</span></div>
        <div id="final-total"><span>ԸՆԴՀԱՆՈՒՐ:</span> <span id="final-total-amount">0.00 Դր</span></div>
    </div>
    
    <hr>
    
    <button class="btn-primary" id="sale-button" onclick="submitSale()">ՎԱՃԱՌՔ</button>

</div>

<script>
    // --- ԿՈՆՖԻԳՈՒՐԱՑԻԱ ---
    // !!! ՓՈԽԱՐԻՆԵԼ ԱՅՍ ՏՈՂԵՐԸ ՁԵՐ ԻՐԱԿԱՆ WEB APP URL-ՆԵՐՈՎ !!!
    const BASE_API_URL = 'https://script.google.com/macros/s/AKfycbyqZQuiIjIx7dok_3OczGy-39z8i8M_omy1c4i8xMQCCFfGNc-4yKJb2AiamX45KQkMFQ/exec'; // Օրինակ: https://script.google.com/macros/s/AKfyc.../exec
    
    // GET-ը կանչում է doGet(e) ֆունկցիան, ավելացնելով ?barcode= ավտոմատ կերպով
    const CATALOG_API_URL = BASE_API_URL + '?barcode='; 
    // POST-ը կանչում է doPost(e) ֆունկցիան
    const SALE_API_URL = BASE_API_URL; 
    
    let products = [];
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const videoElement = document.getElementById('videoElement');
    const overlayElement = document.getElementById('overlay');
    const manualBarcodeInput = document.getElementById('manualBarcodeInput');

    // =======================================================
    // ՖՈՒՆԿՑԻԱ 1: ԿԱՄԵՐԱՅԻ ՄԻԱՑՈՒՄ ԵՎ ՍԿԱՆԱՎՈՐՈՒՄ
    // =======================================================

    function startScanner() {
        overlayElement.textContent = 'Սկանավորվում է... (Փնտրում է կոդը)';
        
        codeReader.getVideoInputDevices()
            .then((videoInputDevices) => {
                if (videoInputDevices.length === 0) {
                    overlayElement.textContent = 'Սխալ: Տեսախցիկ չի գտնվել։';
                    return;
                }
                
                const selectedDeviceId = videoInputDevices.find(device => 
                    device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('environment')
                )?.deviceId || videoInputDevices[0].deviceId;

                codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, error) => {
                    if (result) {
                        overlayElement.textContent = `Կոդը գտնված է: ${result.text}`;
                        processBarcode(result.text); 
                        codeReader.reset(); 
                        setTimeout(startScanner, 2000); // Վերագործարկել 2 վայրկյան հետո
                    }
                    if (error && !(error instanceof ZXing.NotFoundException)) {
                        // Կարող է լինել NotFoundException, որը նորմալ է (կոդ չկա կադրում)
                    }
                });
            })
            .catch((err) => {
                console.error('Սխալ մուտքի ժամանակ:', err);
                overlayElement.textContent = 'Թույլատվության սխալ կամ HTTPS պահանջ։';
            });
    }

    // =======================================================
    // ՖՈՒՆԿՑԻԱ 2: ՁԵՌՔՈՎ ՄՈՒՏՔԱԳՐՈՒՄ
    // =======================================================

    function handleManualInput() {
        const barcode = manualBarcodeInput.value.trim();
        if (barcode) {
            processBarcode(barcode);
            manualBarcodeInput.value = '';
        } else {
            alert('Խնդրում ենք մուտքագրել կոդը։');
        }
    }

    // =======================================================
    // ՖՈՒՆԿՑԻԱ 3: ՓՆՏՐՈՒՄ GOOGLE SHEETS-ՈՒՄ ԵՎ ԱՎԵԼԱՑՈՒՄ (GET)
    // =======================================================

    async function processBarcode(barcode) {
        const existingItem = products.find(p => p.barcode === barcode);
        if (existingItem) {
            changeQuantity(barcode, 1);
            return;
        }

        try {
            overlayElement.textContent = 'Փնտրում է ապրանքը...';
            // Կանչում ենք doGet(e) ֆունկցիան GAS-ում
            const response = await fetch(CATALOG_API_URL + barcode);
            const data = await response.json();
            
            if (data.status === 'success') {
                const newItem = {
                    barcode: barcode,
                    // Այս դաշտերը ստացվում են GAS-ի կողմից
                    product_id: data.product_id,
                    name: data.product_name, // Ստացված անուն
                    unit_price: parseFloat(data.product_price), // Ստացված գին
                    quantity: 1
                };
                products.push(newItem);
                updateProductList();
                overlayElement.textContent = `Ավելացված է: ${newItem.name}`;
            } else {
                alert(`Ապրանքը չի գտնվել (${barcode}): ${data.message || 'Սխալ'}`);
                overlayElement.textContent = 'Կոդը չի գտնվել։';
            }
        } catch (error) {
            console.error('Սխալ API-ի հետ կապի ժամանակ:', error);
            alert('Սխալ: Չհաջողվեց կապվել կատալոգի հետ։');
        }
    }

    // =======================================================
    // ՖՈՒՆԿՑԻԱ 4: ՔԱՆԱԿԻ ՓՈՓՈԽՈՒԹՅՈՒՆ
    // =======================================================
    
    window.changeQuantity = (barcode, change) => {
        const item = products.find(p => p.barcode === barcode);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                products = products.filter(p => p.barcode !== barcode);
            }
            updateProductList();
        }
    }
    
    // =======================================================
    // ՖՈՒՆԿՑԻԱ 5: ՀԵՌԱՑՈՒՄ ՑՈՒՑԱԿԻՑ (DELETE)
    // =======================================================

    window.removeItem = (barcode) => {
        products = products.filter(p => p.barcode !== barcode);
        updateProductList();
    }
    
    // =======================================================
    // ՖՈՒՆԿՑԻԱ 6: ԹԱՐՄԱՑՆԵԼ ՑՈՒՑԱԿԸ ԵՎ ՀԱՇՎԱՐԿԵԼ ԸՆԴՀԱՆՈՒՐԸ
    // =======================================================

    function updateProductList() {
        const listContainer = document.getElementById('products-list');
        listContainer.innerHTML = '';
        
        if (products.length === 0) {
            listContainer.innerHTML = '<p id="empty-list-message">Ցուցակը դատարկ է։</p>';
        }

        products.forEach(item => {
            const total = (item.unit_price * item.quantity).toFixed(2);
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'product-item';
            itemDiv.innerHTML = `
                <div class="item-details">
                    <div>${item.name} (${item.unit_price} Դր)</div>
                    <div>Գումար: ${total} Դր</div>
                </div>
                <div class="item-quantity-controls">
                    <button class="btn-secondary" style="width: 30px;" onclick="changeQuantity('${item.barcode}', -1)">-</button>
                    <span class="quantity-display">${item.quantity}</span>
                    <button class="btn-secondary" style="width: 30px;" onclick="changeQuantity('${item.barcode}', 1)">+</button>
                    <button class="btn-danger" style="width: 30px; margin-left: 10px;" onclick="removeItem('${item.barcode}')">X</button>
                </div>
            `;
            listContainer.appendChild(itemDiv);
        });
        
        calculateTotal();
    }
    
    // =======================================================
    // ՖՈՒՆԿՑԻԱ 7: ԸՆԴՀԱՆՈՒՐԻ ՀԱՇՎԱՐԿ
    // =======================================================

    window.calculateTotal = () => {
        let subTotal = products.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
        
        const discountPercentage = parseFloat(document.getElementById('discount-input').value) || 0;
        const discountFactor = discountPercentage / 100;
        
        const discountAmount = subTotal * discountFactor;
        const finalTotal = subTotal - discountAmount;
        
        document.getElementById('sub-total').textContent = subTotal.toFixed(2) + ' Դր';
        document.getElementById('discount-amount').textContent = discountAmount.toFixed(2) + ' Դր';
        document.getElementById('final-total-amount').textContent = finalTotal.toFixed(2) + ' Դր';
    }

    // =======================================================
    // ՖՈՒՆԿՑԻԱ 8: ՎԱՃԱՌՔԻ ԱՄԱԳՐՈՒՄ (POST)
    // =======================================================

    async function submitSale() {
        if (products.length === 0) {
            alert('Վաճառքի ցուցակը դատարկ է։');
            return;
        }

        const discount = parseFloat(document.getElementById('discount-input').value) || 0;
        const subTotal = products.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
        
        // Պատրաստել տվյալները (POST)
        const saleData = {
            timestamp: new Date().toISOString(),
            items: products.map(p => ({
                barcode: p.barcode,
                quantity: p.quantity,
                unit_price: p.unit_price
            })),
            discount_percentage: discount,
            final_total: subTotal * (1 - discount / 100)
        };

        try {
            const saleButton = document.getElementById('sale-button');
            saleButton.disabled = true;
            saleButton.textContent = 'Մշակվում է...';
            
            // Կանչում ենք doPost(e) ֆունկցիան GAS-ում
            const response = await fetch(SALE_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(saleData)
            });
            
            const result = await response.json();

            if (result.result === 'success') {
                alert('Վաճառքն ամրագրված է։');
                products = [];
                document.getElementById('discount-input').value = 0;
                updateProductList();
            } else {
                alert('Սխալ վաճառքի գրանցման ժամանակ։');
            }
        } catch (error) {
            console.error('Վաճառքի ամրագրման սխալ:', error);
            alert('Կապի սխալ։');
        } finally {
            saleButton.disabled = false;
            saleButton.textContent = 'ՎԱՃԱՌՔ';
        }
    }
    
    // Էջի բեռնումից հետո
    window.onload = startScanner;
</script>

</body>
</html>